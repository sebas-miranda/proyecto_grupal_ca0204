---
title: "Bitacora 2"
format:
  html: default
  pdf: default
editor: visual
---

# Bit√°cora 2 Proyecto Grupal

Integrantes:

- Sebasti√°n Calder√≥n Segura C21517
- Sebasti√°n Miranda Ram√≠rez C4H274
- Josu√© Gustavo Rodr√≠guez Aguilar C4J023
- Kevin David Calderon Mart√≠nez C4D511
- Santiago Paniagua Chavarr√≠a C4I249

La presente bit√°cora documenta el proceso de an√°lisis, depuraci√≥n y exploraci√≥n de los datos correspondientes a los delitos registrados en Costa Rica entre 2019 y julio de 2025, obtenidos del portal de datos abiertos del Poder Judicial. A lo largo del informe se describe el tratamiento de las bases de datos originales, la unificaci√≥n de variables, la detecci√≥n de valores faltantes y at√≠picos, as√≠ como la aplicaci√≥n de t√©cnicas estad√≠sticas para garantizar la coherencia y calidad del conjunto de datos. El objetivo principal es obtener una base limpia y estructurada que permita interpretar con mayor precisi√≥n las tendencias delictivas en el pa√≠s.

```{r include = FALSE}

#setup
library(dplyr)
library(readr)
library(here)
library(ggplot2)
library(sf)
library(stringr)
library(tidyverse)

ruta <- here("data", "processed", "Estad√≠sticas Policiales 2019 a Julio 2025.csv")

datos <- read_csv(ruta)

lab_na <- c("NO APLICA", "DESCONOCIDO")

# Vista general
n.filas <- nrow(datos)
n.cols <- ncol(datos)
variables <- names(datos)
rango.fechas <- range(datos$fecha, na.rm = TRUE)

#Ordenar por orden cron√≥logico los sucesos 

```

## 1

### Caracter√≠sticas de los datos

Se utilizaron las bases de datos de cr√≠menes registrados entre 2019 y julio de 2025, disponibles en el portal de datos del Poder Judicial: <https://sitiooij.poder-judicial.go.cr/index.php/ayuda/servicios-policiales/servicios-a-organizaciones/indice-de-transparencia-del-sector-publico-costarricense/datos-abiertos>.

En este sentido, estas bases ven√≠an separadas por a√±o y presentaban algunas inconsistencias entre ellas. Por ejemplo, entre 2019 y 2023 la variable del sexo se denominaba ‚Äúg√©nero‚Äù, mientras que a partir de 2024 pas√≥ a llamarse ‚Äúsexo‚Äù. Asimismo, la columna de fecha aparec√≠a en formato *char* en algunos a√±os y en formato *Date* en otros.

Para resolver esto, se unificaron los datos, combinando todos los archivos en una √∫nica base que incluye todos los cr√≠menes registrados en el periodo 2019‚Äìjulio 2025.

De esta forma, result√≥ una base de datos con las siguientes caracter√≠sticas:

-   Tama√±o: `{r} n.filas` x `{r} n.cols`.
-   Va de `{r} rango.fechas[1]` a `{r} rango.fechas[2]`.
-   Todas las variables son cualitativas: `{r} variables`.

### Poblaci√≥n de estudio

La poblaci√≥n de estudio corresponde a todos los eventos delictivos ocurridos en Costa Rica de 2019 a julio de 2025.

### Muestra observada

La muestra son las observaciones registradas de delitos en Costa Rica del 01/01/2019 a las 00:00:00 al 31/07/25 a las 23:59:59, almacenadas en la base del Poder Judicial.

### Unidad estad√≠stica

Corresponde a cada observaci√≥n de delito junto con sus atributos: `{r} variables`

### Variables de estudio

| Variable | Tipo | Descripci√≥n |
|------------------------|------------------------|------------------------|
| fecha | Fecha | D√≠a del evento |
| hora | Categ√≥rica | Tramos horarios de 3 horas |
| delito | Categ√≥rica | Categor√≠a principal del hecho |
| subdelito | Categ√≥rica | Subtipo de delito |
| victima | Categ√≥rica | Tipo de v√≠ctima (pueden ser objetos como VIVIENDA o VEH√çCULO). |
| subvictima | Categ√≥rica | Subtipo de v√≠ctima |
| sexo | Categ√≥rica | Sexo de la v√≠ctima. |
| edad | Categ√≥rica | Edad de la v√≠ctima. |
| nacionalidad | Categ√≥rica | Nacionalidad de la v√≠ctima. |
| provincia | Categ√≥rica | Provincia donde ocurri√≥ el hecho |
| canton | Categ√≥rica | Cant√≥n donde ocurri√≥ el hecho |
| distrito | Categ√≥rica | Distrito donde ocurri√≥ el hecho |

**Es importante recalcar que las bases de datos traen columnas correspondientes a persona (edad, sexo, nacionalidad) incluso cuando victima es VEHICULO, VIVIENDA, EDIFICACION, etc; lo cual se puede deber a valores por defecto de captura. Para un correcto an√°lisis se coloca NA en dichas posiciones. Aqui se muestra un ejemplo de como quedar√≠an los datos aplicando estos cambios:**

```{r}
datos %>% 
  select(victima, subvictima, edad, sexo, nacionalidad) %>% 
  filter(victima != "PERSONA") %>% 
  slice_head(n = 10)
```

## 2

Se agregan las primeras 5 filas de nuestra base de datos:

```{r}

slice_head(datos, n = 5)
```

## 3

Uno de los principales retos encontrados en esta base de datos, es que todas las variables de la misma son categ√≥ricas. Es decir, no hay ninguna variable cuantitativa. Incluso la variable de edad, se divide en pocas categorias (NO APLICA, ADULTO MAYOR, MAYOR DE EDAD, MENOR DE EDAD, DESCONOCIDO)

Entonces, para afrontar este reto, se realiza una distribucion de frecuencias como la que se ha mostrado anteriormente. De esta manera, se puede analizar, retomando el caso de la edad por ejemplo, la frecuencia de cada categoria. Pero, se analiza cada variable de acuerdo al orden de la base de datos:

```{r}
resumen_delito <-  read_csv(here("data/processed/resumen_delito.csv"), show_col_types = FALSE)
resumen_delito
```

Estos son los 10 delitos que m√°s frecuencia ha tenido en el pais en los ultimos seis a√±os, aunque no se debe descartar que hay mas de 30 tipos de delitos reportados en los ultimos seis a√±os. Lideran el hurto, asalto, robo, los delitos contra la propiedad y el veh√≠culo como los cinco delitos m√°s frecuentes. Por lo que se puede entender que hay una tendencia hacia los delitos reportados que implican el robo de un bien.

```{r}
resumen_victima <-  read_csv(here("data/processed/resumen_victima.csv"), show_col_types = FALSE)
resumen_victima
```

Con respecto a las v√≠ctimas, aproximadamente la mitad de las v√≠ctimas de los delitos reportados son personas. Note quel total de v√≠ctimas de personas se relaciona con los primeros tres delitos m√°s reportados (Hurto, asalto y robo). Seguido de los veh√≠culos (Robo de veh√≠culos), la vivienda y edificaciones (Delitos contra la propiedad) y los otros. Para efectos de esta investigaci√≥n, el foco de atenci√≥n se centra en las v√≠ctimas que son personas.

```{r}
resumen_edad <-  read_csv(here("data/processed/resumen_edad.csv"), show_col_types = FALSE)
resumen_edad
```

De acuerdo a las frecuencias, se interpretan las mismas como rangos de edad. M√°s de la mitad de las v√≠ctimas no son personas (Como se observa en el cuadro de v√≠ctimas), por lo que, las personas mayores de edad son las que m√°s reportan delitos que ocurren en contra de s√≠ mismas. Tambi√©n se puede observar que bajo los mayores de edad, se encuentran los menores; por lo que han habido m√°s de 10 000 v√≠ctimas menores de edad en los √∫ltimos 6 a√±os. En menor frecuencia los adultos mayores, y por √∫ltimo, m√°s de 7000 casos con edad no registrada.

```{r}
resumen_sexo <-  read_csv(here("data/processed/resumen_sexo.csv"), show_col_types = FALSE)
resumen_sexo
```

An√°logamente con la edad, hay exactamente 185975 casos donde las v√≠ctimas no son personas. Por ende, solo hay registro de m√°s de 58 mil hombres v√≠ctimas de delitos, y m√°s de 34 mil v√≠ctimas mujeres. Se desconoce el sexo de 66000 casos aproximadamente.

```{r}
resumen_nacionalidad <-  read_csv(here("data/processed/resumen_nacionalidad.csv"), show_col_types = FALSE)
resumen_nacionalidad
```

Obviando los casos donde las v√≠ctimas no son personas, aproximadamente el 37% de las v√≠ctimas son de nacionalidad costarricense, seguidamente del 5% de las v√≠ctimas, que son nicaraguenses, el 1,36% son casos no registrados y el 0,55% de v√≠ctimas han sido estadounidenses.

```{r}
resumen_provincia <-  read_csv(here("data/processed/resumen_provincia.csv"), show_col_types = FALSE)
resumen_provincia
```

Ac√° se puede observar la frecuencia de delitos cometidos de acuerdo a la provincia. Siendo la capital la provincia donde m√°s se reportan delitos, seguido de Alajuela, con una diferencia de reporte de delitos de 75612 casos, una variaci√≥n muy alta, a diferencia de las siguientes provincias. Por √∫ltimo, Cartago, la provincia donde menos se reportan delitos, y 29 casos de los que no se tiene informaci√≥n.

## 4

Se ha hecho un grafico de la distribucion de cada tabla de frecuencia. Aca se muestran las mas relevantes

Variable delito

```{r}
grafico_delito <- resumen_delito %>% 
  arrange(desc(frecuencia_de_delitos)) %>% 
  mutate(delito = factor(delito, levels = delito)) %>% 
  ggplot(aes(x =delito, y = frecuencia_de_delitos, fil = delito)) +
  geom_bar(stat = "identity", fill = "skyblue", show.legend = FALSE) +
  coord_flip() +
  labs(
    title = "10 delitos ocurridos m√°s frecuentres en Costa Rica entre 2019 y 2025", 
    x = "Delito",
    y = "Frecuencia"
  ) +
  theme_minimal()
grafico_delito
```

Variable victima

```{r}
grafico_victima <- resumen_victima %>% 
  mutate(victima = factor(victima, levels = victima)) %>% 
  ggplot(aes(x = victima, y = frecuencia_de_victimas)) +
  geom_bar(stat = "identity", fill = "darkorchid4") +
  coord_flip()+
  labs(title = "Victimas m√°s frecuentes de un delito en Costa Rica entre 2019 y 2025") +
  theme_minimal()
#Guardamos
ggsave(
  filename = here("info", "graphics", "grafico_victima.png"),
  plot = grafico_victima, 
  width = 15, height = 10, dpi = 200
)
grafico_victima
```

Variable sexo

```{r}
grafico_sexo <- resumen_sexo %>% 
  mutate(sexo = factor(sexo, levels = sexo)) %>% 
  ggplot(aes(x = sexo, y = frecuencia_de_sexo)) +
  geom_bar(stat = "identity", fill = "chocolate3" ) +
  coord_flip() +
  labs(title = "Variaci√≥n del sexo de la v√≠ctima de un delito en Costa Rica entre 2019 y 2025",
       x = "Sexo",
       y = "Frecuencia") +
  theme_minimal()
#Guardamos
ggsave(
  filename = here("info", "graphics", "grafico_sexo.png"),
  plot = grafico_sexo, 
  width = 15, height = 10, dpi = 200
)
grafico_sexo
```

Variable canton

```{r}
resumen_canton <- datos %>% 
  count(canton, name = "frecuencia_de_cantones") %>% 
  arrange(desc(frecuencia_de_cantones))

resumen_canton <- resumen_canton %>% 
  filter(canton != "DESCONOCIDO")

cantones <- st_read("../data_raw/shapefiles/unidad_geoestadistica_cantonal_ugec_2024.shp",quiet = TRUE)

cantones <- cantones  %>% 
  mutate(nomb_ugec = str_to_upper(nomb_ugec),
         nomb_ugec = str_replace_all(nomb_ugec, c(
           "√Å" = "A", "√â" = "E", "√ç" = "I", "√ì" = "O", "√ö" = "U", "√ë" = "N"
         )))

cantones <- cantones %>% 
  left_join(resumen_canton, by = c("nomb_ugec"= "canton"))

grafico_cantones <- ggplot(cantones) +
  geom_sf(aes(fill = frecuencia_de_cantones), color = "white") +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "Frecuencia de reportes de delito por canton en Costa Rica entre 2019 y 2025", fill = "Frecuencia")
grafico_cantones
```

## 5

Al ser variables categoricas, se debe de tener coherencia a la hora de comparar variables.

En este caso, se compara primero, la variable de provincia con la de delito, es decir, contabilizar los distintos tipos de delitos que ocurren en Costa Rica en funcion a su provincia:

```{r}
ruta.entrada <- here("data", "processed", "Estad√≠sticas Policiales 2019 a Julio 2025.csv")
datos <- read_csv(ruta.entrada, show_col_types = FALSE)

#Df enfocaddo en relacionar los delitos por provincia
filtro <- datos %>% 
  filter(!provincia %in% c("DESCONOCIDO", "NO APLICA"),
         delito != "DESCONOCIDO")

delitos_mas_frecuentes <-  filtro %>% 
  group_by(delito) %>% 
  summarise(frecuencia.delito = n(), .groups = "drop") %>% 
  arrange(desc(frecuencia.delito)) %>% 
  slice_head(n = 10) %>% 
  pull(delito)

delito_provincia <- filtro %>% 
  filter(delito %in% delitos_mas_frecuentes) %>% 
  group_by(provincia, delito) %>% 
  summarise(frecuencia = n(), .groups = "drop") %>% 
  mutate(provincia = factor(provincia), delito = factor(delito))

#Relacion entre fechas y provincias
grafico_delito_provincia <- delito_provincia %>% 
  ggplot(aes(x = provincia, y = frecuencia, fill = delito)) +
  geom_bar(stat ="identity") +
  coord_flip() +
  labs(title = "Delitos por provincia en Costa Rica entre 2019 y 2025",
       x = "Provincia",
       y ="Frecuencia")

grafico_delito_provincia
```

Ahora, la relacion entre la variable sexo y edad. Es decir, la distribucion de los rangos de edad de acuerdo al sexo que han reportado un delito en Costa Rica entre 2019 y 2025:

```{r}

resumen_sexo_edad <- datos %>%
  filter(!edad %in% c("DESCONOCIDO", "NO APLICA"),
         !sexo %in% c("DESCONOCIDO", "NO APLICA")) %>% 
  group_by(sexo, edad) %>% 
  summarise(frecuencia = n(), .groups = "drop")

#Grafico
grafico_sexo_edad <- resumen_sexo_edad %>% 
  ggplot(aes(x = edad, y = frecuencia, fill = sexo)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("HOMBRE" = "blue4", "MUJER" = "pink3")) +
  labs(title = "Distribucion de victimas de un delito en Costa Rica en funcion del sexo y la edad",
       x = "Rangos de edad",
       y = "Frecuencia") +
  theme_minimal()
grafico_sexo_edad
```

## 6

## 7

Para identificar los valores faltantes, es √∫til convertir los valores que aparecen como NO APLICA o DESCONOCIDO en verdaderos valores faltantes (NA) solo cuando el valor no tiene sentido en funci√≥n del tipo de v√≠ctima. Para esto se puede modelar una funci√≥n que detecta NA en cada archivo y genera un reporte de cu√°ntos valores faltan. 

```{r}

reporte_faltantes_df <- function(df, dataset_name = "", etiquetas = c("DESCONOCIDO", "NO APLICA")){
  total_rows   <- nrow(df)
  na_reales    <- sapply(df, function(x) sum(is.na(x)))
  na_etiquetas <- sapply(df, function(x) if (is.character(x)) sum(x %in% etiquetas) else 0L)
  data.frame(
    dataset      = dataset_name,
    columna      = names(df),
    na_reales    = as.integer(na_reales),
    na_etiqueta  = as.integer(na_etiquetas),
    na_total     = as.integer(na_reales + na_etiquetas),
    pct_faltante = round(100 * (na_reales + na_etiquetas) / max(total_rows, 1L), 2),
    row.names = NULL
  )
}

# Reportes (uno por cada resumen)
reporte_faltantes <- rbind(
  reporte_faltantes_df(resumen_canton,       "resumen_canton"),
  reporte_faltantes_df(resumen_delito,       "resumen_delito"),
  reporte_faltantes_df(resumen_edad,         "resumen_edad"),
  reporte_faltantes_df(resumen_nacionalidad, "resumen_nacionalidad"),
  reporte_faltantes_df(resumen_provincia,    "resumen_provincia"),
  reporte_faltantes_df(resumen_sexo,         "resumen_sexo"),
  reporte_faltantes_df(resumen_victima,      "resumen_victima")
)

# Mostrar el reporte completo
reporte_faltantes
```

Ahora, para identificar outliers se va a utilizar el m√©todo IQR (Interquartile Range o Rango Intercuart√≠lico) la cual es una t√©cnica estad√≠stica utilizada para identificar valores at√≠picos en un conjunto de datos. Un valor se considera outlier si se encuentra fuera de los l√≠mites:ùë•< Q1 ‚àí 1.5 √ó IQR oùë•> Q3 + 1.5 √ó IQR. Donde IQR=Q3-Q1.
Este m√©todo es robusto porque no se ve afectado por la asimetr√≠a o valores extremos aislados. En este proyecto se utilizar√° el criterio del 1.5 √ó IQR, que es el mismo que emplean los gr√°ficos de caja (boxplots) para detectar valores inusualmente altos o bajos en las frecuencias de delitos.


```{r}
# Funci√≥n que detecta outliers por regla IQR 
outliers_iqr <- function(df, id_col, val_col, dataset){
  v  <- df[[val_col]]
  q1 <- quantile(v, 0.25, na.rm = TRUE)
  q3 <- quantile(v, 0.75, na.rm = TRUE)
  iqr <- q3 - q1
  lim_inf <- q1 - 1.5 * iqr
  lim_sup <- q3 + 1.5 * iqr
  
  out <- df[v < lim_inf | v > lim_sup, c(id_col, val_col), drop = FALSE]
  names(out) <- c("id", "valor")
  mutate(out, dataset = dataset, .before = 1)
}


# Aplicaci√≥n a cada resumen
o_canton    <- outliers_iqr(resumen_canton,       "canton",       "frecuencia_de_cantones",       "resumen_canton")
o_delito    <- outliers_iqr(resumen_delito,       "delito",       "frecuencia_de_delitos",        "resumen_delito")
o_edad      <- outliers_iqr(resumen_edad,         "edad",         "frecuencia_rango_de_edades",   "resumen_edad")
o_nacional  <- outliers_iqr(resumen_nacionalidad, "nacionalidad", "frecuencia_de_nacionalidades", "resumen_nacionalidad")
o_provincia <- outliers_iqr(resumen_provincia,    "provincia",    "frecuencia_de_provincias",     "resumen_provincia")
o_sexo      <- outliers_iqr(resumen_sexo,         "sexo",         "frecuencia_de_sexo",           "resumen_sexo")
o_victima   <- outliers_iqr(resumen_victima,      "victima",      "frecuencia_de_victimas",       "resumen_victima")

outliers_consolidados <- bind_rows(
  o_canton, o_delito, o_edad, o_nacional, o_provincia, o_sexo, o_victima
)

outliers_consolidados
```

## 8

Se identificaron anteriormente la presencia de valores vac√≠os o NA en las bases de datos. Para esto, se aplica una estrategia distinta para diferentes tipos de variables, con el objetivo de obtener una base de datos m√°s limpia y sin cosas innecesarias, el cual se muestra a continuaci√≥n:

```{r}
# Demogr√°ficas: quitar NO APLICA / DESCONOCIDO (para an√°lisis sobre personas)
resumen_edad_clean <- resumen_edad %>% filter(!edad %in% lab_na)
resumen_sexo_clean <- resumen_sexo %>% filter(!sexo %in% lab_na)
resumen_nacionalidad_clean <- resumen_nacionalidad %>% filter(!nacionalidad %in% lab_na)

# Territoriales: quitar DESCONOCIDO
resumen_provincia_clean <- resumen_provincia %>% filter(!provincia %in% "DESCONOCIDO")
resumen_canton_clean    <- resumen_canton %>% filter(!canton %in% "DESCONOCIDO")

# Delito/V√≠ctima: conservar todo
resumen_delito_clean  <- resumen_delito
resumen_victima_clean <- resumen_victima
```

En el punto anterior se observaron muchos outliers, los cual se debe corregir. La winsorizaci√≥n es una t√©cnica estad√≠stica utilizada para reducir el efecto de valores extremos sin eliminarlos del conjunto de datos. Consiste en reemplazar los valores que superan los l√≠mites definidos (ya sea por percentiles o por el rango intercuart√≠lico) por el valor m√°s cercano dentro de esos l√≠mites. En este proyecto se aplicar√° una winsorizaci√≥n basada en el m√©todo IQR (1.5 √ó IQR), con el fin de suavizar la influencia de los cantones o delitos con frecuencias extremadamente altas, como San Jos√© o Hurto, los cuales, aunque representan fen√≥menos reales, podr√≠an distorsionar la visualizaci√≥n y el an√°lisis estad√≠stico. De esta forma se conserva la informaci√≥n esencial sin perder la coherencia general de la distribuci√≥n.

```{r}

# Funci√≥n winsorizar por IQR (1.5 x IQR)
winsorizar_iqr <- function(df, col_valor){
  v   <- df[[col_valor]]
  q1  <- quantile(v, 0.25, na.rm = TRUE)
  q3  <- quantile(v, 0.75, na.rm = TRUE)
  iqr <- q3 - q1
  lim_inf <- q1 - 1.5 * iqr
  lim_sup <- q3 + 1.5 * iqr
  df %>%
    mutate(
      !!paste0(col_valor, "_winsor") := pmin(pmax(.data[[col_valor]], lim_inf), lim_sup),
      !!paste0(col_valor, "_log")    := log10(.data[[col_valor]] + 1)  
    )
}

# Winsorizaci√≥n por IQR
resumen_canton_w  <- winsorizar_iqr(resumen_canton_clean,       "frecuencia_de_cantones")
resumen_delito_w  <- winsorizar_iqr(resumen_delito_clean,        "frecuencia_de_delitos")
resumen_edad_w    <- winsorizar_iqr(resumen_edad_clean,          "frecuencia_rango_de_edades")
resumen_nac_w     <- winsorizar_iqr(resumen_nacionalidad_clean,  "frecuencia_de_nacionalidades")
resumen_prov_w    <- winsorizar_iqr(resumen_provincia_clean,     "frecuencia_de_provincias")
resumen_sexo_w    <- winsorizar_iqr(resumen_sexo_clean,          "frecuencia_de_sexo")
resumen_victima_w <- winsorizar_iqr(resumen_victima_clean,       "frecuencia_de_victimas")

#vista rapida
head(resumen_canton_w)
head(resumen_delito_w)
head(resumen_prov_w)
```

Tras la limpieza y an√°lisis de las bases de datos, se logr√≥ identificar patrones relevantes y reducir el impacto de valores at√≠picos mediante la aplicaci√≥n de la t√©cnica de winsorizaci√≥n. Esto permiti√≥ mantener la integridad de la informaci√≥n sin distorsionar las distribuciones originales. En general, la bit√°cora refleja un proceso metodol√≥gico que asegura la confiabilidad de los datos para futuros an√°lisis estad√≠sticos y geoespaciales sobre la criminalidad en Costa Rica.

## Bibliografia

\
[https://rpubs.com/Juve_Campos/ImagenesyMultimediaEnRmarkdown](#0)\
\
<https://ggplot2.tidyverse.org/reference/coord_flip.html>\
\
<https://es.scribd.com/document/432904420/Paleta-de-Colores-en-R>\
[\
https://mapscaping.com/read-write-shapefiles-in-r/](https://mapscaping.com/read-write-shapefiles-in-r/)

<https://r-charts.com/es/espacial/mapa-burbujas/>
